var quillMention=function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function n(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function s(){return(s=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t}).apply(this,arguments)}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function h(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=o(t);if(e){var s=o(this).constructor;i=Reflect.construct(n,arguments,s)}else i=n.apply(this,arguments);return a(this,i)}}function l(t,e,i){return(l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=o(t)););return t}(t,e);if(n){var s=Object.getOwnPropertyDescriptor(n,e);return s.get?s.get.call(i):s.value}})(t,e,i||t)}t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;var u=9,c=13,d=27,f=38,m=40;function p(t,e,i){var n=t;return Object.keys(e).forEach((function(t){i.indexOf(t)>-1?n.dataset[t]=e[t]:delete n.dataset[t]})),n}var g=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}(s,t);var i=h(s);function s(){return e(this,s),i.apply(this,arguments)}return n(s,null,[{key:"create",value:function(t){var e=l(o(s),"create",this).call(this),i=document.createElement("span");return i.className="ql-mention-denotation-char",i.innerHTML=t.denotationChar,e.appendChild(i),e.innerHTML+=t.value,s.setDataValues(e,t)}},{key:"setDataValues",value:function(t,e){var i=t;return Object.keys(e).forEach((function(t){i.dataset[t]=e[t]})),i}},{key:"value",value:function(t){return t.dataset}}]),s}(t.import("blots/embed"));g.blotName="mention",g.tagName="span",g.className="mention",t.register(g);var C=function(){function i(t,n){e(this,i),this.isOpen=!1,this.itemIndex=0,this.mentionCharPos=null,this.cursorPos=null,this.values=[],this.suspendMouseEnter=!1,this.lastAutocompleteText="",this.quill=t,this.isIE=!!window.MSInputMethodContext&&!!document.documentMode,this.isSafari=/^((?!chrome|android|crios|fxios).)*safari/i.test(navigator.userAgent),this.iOS=/iPhone|iPad|iPod/i.test(navigator.userAgent),this.isInsertingItem=!1,this.options={source:null,renderItem:function(t){return"".concat(t.value)},onSelect:function(t,e){e(t)},mentionDenotationChars:["@"],showDenotationChar:!0,allowedChars:/^[a-zA-Z0-9_]*$/,minChars:0,maxChars:31,offsetTop:2,offsetLeft:0,isolateCharacter:!1,fixMentionsToQuill:!1,defaultMenuOrientation:"bottom",blotName:"mention",dataAttributes:["id","value","denotationChar","link","target"],linkTarget:"_blank",onOpen:function(){return!0},onClose:function(){return!0},listItemClass:"ql-mention-list-item",mentionContainerClass:"ql-mention-list-container",mentionListClass:"ql-mention-list",spaceAfterInsert:!0},s(this.options,n,{dataAttributes:Array.isArray(n.dataAttributes)?this.options.dataAttributes.concat(n.dataAttributes):this.options.dataAttributes}),this.mentionContainer=document.createElement("div"),this.mentionContainer.className=this.options.mentionContainerClass?this.options.mentionContainerClass:"",this.mentionContainer.style.cssText="display: none; position: absolute;",this.mentionContainer.onmousemove=this.onContainerMouseMove.bind(this),this.options.fixMentionsToQuill&&(this.mentionContainer.style.width="auto"),this.mentionList=document.createElement("ul"),this.mentionList.className=this.options.mentionListClass?this.options.mentionListClass:"",this.mentionContainer.appendChild(this.mentionList),this.quill.container.appendChild(this.mentionContainer),t.on("text-change",this.onTextChange.bind(this)),t.on("selection-change",this.onSelectionChange.bind(this)),t.keyboard.addBinding({key:u},this.selectHandler.bind(this)),t.keyboard.bindings[u].unshift(t.keyboard.bindings[u].pop()),t.keyboard.addBinding({key:c},this.selectHandler.bind(this)),t.keyboard.bindings[c].unshift(t.keyboard.bindings[c].pop()),t.keyboard.addBinding({key:d},this.escapeHandler.bind(this)),t.keyboard.addBinding({key:f},this.upHandler.bind(this)),t.keyboard.addBinding({key:m},this.downHandler.bind(this))}return n(i,[{key:"selectHandler",value:function(){return!this.isOpen||(this.selectItem(),!1)}},{key:"escapeHandler",value:function(){return!this.isOpen||(this.hideMentionList(),!1)}},{key:"upHandler",value:function(){return!this.isOpen||(this.prevItem(),!1)}},{key:"downHandler",value:function(){return!this.isOpen||(this.nextItem(),!1)}},{key:"showMentionList",value:function(){this.mentionContainer.style.visibility="hidden",this.mentionContainer.style.display="",this.mentionContainer.scrollTop=0,this.setMentionContainerPosition(),this.setIsOpen(!0)}},{key:"hideMentionList",value:function(){this.mentionContainer.style.display="none",this.setIsOpen(!1)}},{key:"highlightItem",value:function(){for(var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=0;e<this.mentionList.childNodes.length;e+=1)this.mentionList.childNodes[e].classList.remove("selected");if(this.mentionList.childNodes[this.itemIndex].classList.add("selected"),t){var i=this.mentionList.childNodes[this.itemIndex].offsetHeight,n=this.mentionList.childNodes[this.itemIndex].offsetTop,s=(this.itemIndex,this.mentionContainer.scrollTop),o=s+this.mentionContainer.offsetHeight;n<s?this.mentionContainer.scrollTop=n+i-this.mentionContainer.offsetHeight:n+i>o&&(this.mentionContainer.scrollTop=n-i)}}},{key:"getItemData",value:function(){var t=this.mentionList.childNodes[this.itemIndex].dataset.link,e=void 0!==t,i=this.mentionList.childNodes[this.itemIndex].dataset.target;return e&&(this.mentionList.childNodes[this.itemIndex].dataset.value='<a href="'.concat(t,'" target=').concat(i||this.options.linkTarget,">").concat(this.mentionList.childNodes[this.itemIndex].dataset.value)),this.mentionList.childNodes[this.itemIndex].dataset}},{key:"onContainerMouseMove",value:function(){this.suspendMouseEnter=!1}},{key:"selectItem",value:function(){var t=this,e=this.getItemData();this.options.onSelect(e,(function(e){t.lastAutocompleteText="",t.insertItem(e)})),this.hideMentionList()}},{key:"insertItem",value:function(e){var i=this,n=e;if(null!==n){this.isSafari&&(this.isInsertingItem=!0),this.options.showDenotationChar||(n.denotationChar="");var s=this.mentionCharPos;this.quill.deleteText(this.mentionCharPos,this.cursorPos-this.mentionCharPos,t.sources.USER),this.quill.insertEmbed(s,this.options.blotName,n,t.sources.USER),this.options.spaceAfterInsert?(this.quill.insertText(s+1," ",t.sources.USER),this.quill.setSelection(s+2,t.sources.USER),this.iOS&&this.quill.blur()):this.quill.setSelection(s+1,t.sources.USER),this.hideMentionList(),this.isSafari&&setTimeout((function(){i.isInsertingItem=!1}),100)}}},{key:"onItemMouseEnter",value:function(t){if(!this.suspendMouseEnter){var e=Number(t.target.dataset.index);Number.isNaN(e)||e===this.itemIndex||(this.itemIndex=e,this.highlightItem(!1))}}},{key:"onItemClick",value:function(t){t.preventDefault(),t.stopImmediatePropagation(),this.itemIndex=t.currentTarget.dataset.index,this.highlightItem(),this.selectItem()}},{key:"renderList",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!this.isSafari||!this.isInsertingItem)if(e&&e.length>0){this.values=e,this.mentionList.innerHTML="";for(var o=0;o<e.length;o+=1){var r=document.createElement("li");r.className=this.options.listItemClass?this.options.listItemClass:"",r.dataset.index=o,r.innerHTML=this.options.renderItem(e[o],i),r.onmouseenter=this.onItemMouseEnter.bind(this),r.dataset.denotationChar=t,r.onclick=this.onItemClick.bind(this),this.mentionList.appendChild(p(r,e[o],this.options.dataAttributes))}n?(this.itemIndex=s,this.highlightItem()):(this.itemIndex=0,this.highlightItem(),this.showMentionList())}else this.hideMentionList()}},{key:"nextItem",value:function(){this.itemIndex=(this.itemIndex+1)%this.values.length,this.suspendMouseEnter=!0,this.highlightItem()}},{key:"prevItem",value:function(){this.itemIndex=(this.itemIndex+this.values.length-1)%this.values.length,this.suspendMouseEnter=!0,this.highlightItem()}},{key:"containerBottomIsNotVisible",value:function(t,e){return t+this.mentionContainer.offsetHeight+e.top>window.pageYOffset+window.innerHeight}},{key:"containerRightIsNotVisible",value:function(t,e){return!this.options.fixMentionsToQuill&&t+this.mentionContainer.offsetWidth+e.left>window.pageXOffset+document.documentElement.clientWidth}},{key:"setIsOpen",value:function(t){this.isOpen!==t&&(t?this.options.onOpen():this.options.onClose(),this.isOpen=t)}},{key:"setMentionContainerPosition",value:function(){var t=this,e=this.quill.container.getBoundingClientRect(),i=this.quill.getBounds(this.mentionCharPos),n=this.mentionContainer.offsetHeight,s=this.options.offsetTop,o=this.options.offsetLeft;if(this.options.fixMentionsToQuill){this.mentionContainer.style.right="".concat(0,"px")}else o+=i.left;if(this.containerRightIsNotVisible(o,e)){var r=this.mentionContainer.offsetWidth+this.options.offsetLeft;o=e.width-r}if("top"===this.options.defaultMenuOrientation){if((s=this.options.fixMentionsToQuill?-1*(n+this.options.offsetTop):i.top-(n+this.options.offsetTop))+e.top<=0){var a=this.options.offsetTop;this.options.fixMentionsToQuill?a+=e.height:a+=i.bottom,s=a}}else if(this.options.fixMentionsToQuill?s+=e.height:s+=i.bottom,this.containerBottomIsNotVisible(s,e)){var h=-1*this.options.offsetTop;this.options.fixMentionsToQuill||(h+=i.top),s=h-n}s>=0?this.options.mentionContainerClass.split(" ").forEach((function(e){t.mentionContainer.classList.add("".concat(e,"-bottom")),t.mentionContainer.classList.remove("".concat(e,"-top"))})):this.options.mentionContainerClass.split(" ").forEach((function(e){t.mentionContainer.classList.add("".concat(e,"-top")),t.mentionContainer.classList.remove("".concat(e,"-bottom"))})),this.mentionContainer.style.top="".concat(s,"px"),this.mentionContainer.style.left="".concat(o,"px"),this.mentionContainer.style.visibility="visible"}},{key:"getTextBeforeCursor",value:function(){var t=Math.max(0,this.cursorPos-this.options.maxChars);return this.quill.getText(t,this.cursorPos-t)}},{key:"onSomethingChange",value:function(t){var e=this.quill.getSelection();if(null!=e){this.cursorPos=e.index;var i,n=this.getTextBeforeCursor()||"",s=(i=n,this.options.mentionDenotationChars.reduce((function(t,e){var n=i.lastIndexOf(e);return n>t.mentionCharIndex?{mentionChar:e,mentionCharIndex:n}:{mentionChar:t.mentionChar,mentionCharIndex:t.mentionCharIndex}}),{mentionChar:null,mentionCharIndex:-1})),o=s.mentionChar,r=s.mentionCharIndex;if(function(t,e,i){return t>-1&&!(i&&0!==t&&!e[t-1].match(/\s/g))}(r,n,this.options.isolateCharacter)){if(this.iOS&&this.quill.selection.composing&&this.cursorPos++,(this.isIE||this.isSafari)&&this.quill.selection.composing)(Array.isArray(t)&&t.length>0&&t[0].retain?t[0].retain:-9999)===this.cursorPos&&this.cursorPos++,n=this.getTextBeforeCursor();if(this.isSafari&&this.quill.selection.composing&&Array.isArray(t)&&3!==t.length)return;var a=this.cursorPos-(n.length-r);this.mentionCharPos=a;var h=n.substring(r+o.length);(this.isIE||this.isSafari)&&(h=h.replace(/\s/g,""));var l=!!h.slice(-1).match(/[\uac00-\ud7a3]/),u=this.lastAutocompleteText.length>h.length;if(this.lastAutocompleteText=h,this.isIE&&!this.quill.selection.composing&&l&&!u)return;if(h.length>=this.options.minChars&&function(t,e){return e.test(t)}(h,this.options.allowedChars)){if(this.isSafari&&this.isInsertingItem)return;this.options.source(h,this.renderList.bind(this,o),o)}else this.hideMentionList()}else this.hideMentionList()}}},{key:"onTextChange",value:function(t,e,i){"user"===i&&this.onSomethingChange(t.ops)}},{key:"onSelectionChange",value:function(t){t&&0===t.length?this.onSomethingChange():this.hideMentionList()}}]),i}();return t.register("modules/mention",C),C}(Quill);
